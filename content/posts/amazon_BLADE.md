---
title: '✏️ 비대칭을 해결하기 위한 아마존의 무기, BLADE'
date: '2023-10-06'
categories: ['GNN', 'Deep Learning', 'RecSys']
showToc: true
ShowBreadCrumbs: true
comments : true
draft : true
---

## 0. Vanilla Phone

나는 스마트폰 케이스를 따로 끼질 않는다. 스마트폰 액정 필름도 마찬가지다. 이런 `바닐라 스마트폰`을 보면 대다수는 우려 섞인 시선과 함께 "떨어뜨려서 폰이 깨지면 어떡하나요?"하고 걱정하곤 한다. 그럴때마다 "저는 잘 안 떨어뜨려요."하고 웃으며 넘긴다. 실제로 폰을 잘 안 떨어뜨리기도 하지만 한편으로는 스마트폰 자체의 견고함을 믿는 마음도 있다. 설령 떨어뜨려서 상처가 나면 어떠하리. 고치면 되는 것을. 물론 그보다도, 그냥 어떠한 케이스도 씌우지 않은 스마트폰 본연의 모습이 가장 아름답다는 이유가 가장 크다.

그럼에도 가끔은 쇼핑몰에서 스마트폰 케이스를 구경할 때가 있다. "음 요즘은 스마트폰에 요란한 스트랩을 매다는게 유행이군."하며 트렌드 분석가 마냥 흐름을 파악하려는 건 아니고, 케이스 자체가 예쁜 브랜드들을 종종 발견하면 구매하고 싶은 욕구가 들기도 하니까. 케이스를 구경하다가 또 다른 추천 목록에 뜬 부가 상품들을 구경하다보면 시간이 가는 줄 모른다.

![](/images/recsys/phone.webp)

스마트폰 케이스를 재밌게 구경하던 와중에 추천 상품에 아이폰 혹은 갤럭시 스마트폰 불쑥 뜬다면 아마도 뜬금없다는 느낌을 받을 것이다. 왜냐하면 나는 이미 스마트폰이 있으니까 케이스나 필름을 고르는 터인데, 스마트폰을 추천한다고? 이건 굳이 필요없는 행동일 수 있다. 반면에 내가 아이폰, 갤럭시를 구경하다가 추천 상품에 관련 케이스가 뜨는 건 이상하지 않을 것이다. 합리적인 추천이라는 생각에 아이쇼핑을 신나게 하겠지. 즉 스마트폰과 스마트폰 케이스는 서로 연관되어 있는 제품이지만 그 관계는 동등하지 않다. 이른바 `asymmetric relationship`이다.

제품을 추천하는 데 있어서 이런 `asymmetric relationship`은 골칫거리중 하나다. 이렇게 비대칭적인 연관 제품 관계를 추천 시스템에서 해결하기 위해 등장한 논문 하나를 가지고 왔다.


## 1. RecSys 2023

우선 논문을 소개하기 앞서서 지난 9월 18일부터 22일까지 싱가포르에서 개최된 RecSys 2023 이야기부터 하겠다. 이름에서 알 수 있듯 추천 시스템 분야의 새로운 연구 결과와 기술을 발표하는 포럼인데, ACM에서 개최하고 있다. ACM은 1947년에 설립된 세계 최대 규모의 컴퓨터 과학 분야의 국제 학회다. 올해의 RecSys는 싱가포르의 선텍시티 컨벤션 센터에서 개최됐다. 크고 웅장한 규모를 자랑한다.

![](/images/recsys/suntec.jpeg)

3일 동안 세 번에 걸쳐서 기조연설이 있었는데, 세 번 중 두 번의 주제가 LLM일만큼 추천 시스템에서도 LLM은 큰 관심을 받고 있다. 우선 첫 날은 Microsoft의 수석과학자 제이미 티반(Jamie Teevan)이 어떻게 LLM이 우리 업무에 영향을 미치는지, LLM이 업무 생산성과 창의성에 어떤 영향을 주는지에 대해 설명하였다. 둘째날 기조연설을 담당한 건 싱가포르 국립대학교의 KITHCT 석좌교수인 추아 박사였다. 그는 LLM 기반 서비스가 가지고 있는 현재의 문제점, 이를테면 신뢰성 문제 등을 개선해서 최종적으로 어떻게 Generative 검색과 추천 서비스에 다다를 수 있는지에 대해 이야기했다.

오늘 이야기할 `asymmetri relationship`에 대한 이야기는 마지막 날 기조연설에서 확인할 수 있다. 이 날의 기조연설은 Amazon International Emerging Stores 부의 응용과학담당 부사장 Rajeev Rastogi가 했는데, 그는 연설에서 아마존이 추천 알고리즘 작업에서 직면한 세가지 문제에 대해 이야기하였다. 세가지 문제는 다음과 같다.

1. 방향성 그래프에서의 추천 시스템 문제
2. 시간이 지남에 따라 대상 레이블이 변경될 경우 머신러닝 모델 훈련의 문제
3. 예측 불확실성 추정치를 활용해 모델의 정확도를 개선하는 문제

`asymmetri relationship`는 바로 첫 번째 문제와 연관이 있다.


## 2. Directed Graphs

첫 번째 문제는 엣지가 한 방향으로 이어지는 방향성 그래프와 관련되어 있음
왜냐하면 연관 제품 관계는 비대칭적이거든
가령 휴대폰 노드와 휴대폰 케이스 노드가 있다고 가정해보겠음
휴대폰 노드가 주어지면 휴대폰 케이스 노드를 추천하고 싶은 게 인지상정 / 이건 합리적임

하지만 그 반대라면? 
고객이 휴대폰 케이스를 구매한 적이 있다면 이미 그 고객은 휴대폰을 가지고 있을 것
이 경우엔 휴대폰 추천이 필요하지 않을 수 있다
이런게 바로 asymmetric relationship
그리고 이걸 그래프로 표시하면 방향성 그래프가 될 것

단일 임베딩 공간은 방향성 그래프에서 노드 간 비대칭 관계를 모델링 하기에 표현력이 부족하다는 한계가 있음
그래서 아마존에서는 전체 그래프 구조를 활용해 이중 임베딩을 학습
아마존이 자체 개발한 BLADE 알고리즘을 적용해 해결

또한 바닐라 GNN에선 모든 노드에 대해 고정된 이웃 크기를 샘플링함
아마존에서는 최적화를 위해 adaptive sampling 기술을 추가로 적용하였다고


## 3. BLADE

Biased Locally Adaptive Direction AwarE
이 알고리즘은 WSDM 2023에서 아마존이 발표한 것
논문의 목표는 다음과 같다
방향성 그래프와 쿼리 노드가 입력값일 때 쿼리 노드와 연결될 가능성이 높은 상위 노드를 추천하는 것이 목표

해결 방법
엣지의 존재 유무와 엣지의 방향을 동시에 포착하기 위해 비대칭 손실함수를 사용
각 노드에 대해 인접 노드의 feature를 적절히 집계하여 개별 임베딩 수행
노드의 연결 구조에 따라 국지적으로 서로 다른 다양한 이웃을 생성하는 이웃-기반 샘플링 


 
### 그래프 문제로 관련 상품 추천하기
쿼리 상품 Q가 주어졌을 때, Q와 함께 구매될 가능성이 높은 상위 K개의 상품을 추천이 목표
고객-제품 간 상호작용을 바탕으로 제품 그래프 G를 자연스럽게 구성할 수 있음
문제는 방향성 그래프의 노드 추천임

### 하지만 그래프로 바라볼 때의 문제점
1. 본질적으로 제품-제품 관계는 비대칭적이다
즉 그래프로 표현하면 방향이 존재하는 그래프(directed graph)라고 할 수 있다.
그런데 방향성 그래프를 처리하는 랜덤워크 기반 모델은 GNN에 비해 성능이 떨어진다.

2. 노드와 엣지 feature를 구성하는데 사용할 수 있는 제품 메타데이터가 없을 수 있다

3. GNN 선행 연구들이 low-degree 노드에서는 성능이 좋지 않다
대부분의 GNN 선행연구들이 high-degree 노드 기반 / low-degree 노드에 최적화되지 않음
하지만 이론과 현실은 다르다. 이른바 power-law
대규모 그래프에서 high-degree 노드에 비해 low-degree 노드가 훨씬 더 많다!


### 도전 과제
1. 비대칭성을 존중하면서 제품 관계 모델링하기
GCN, GraphSage, GAT 등과 같이 널리 사용되는 GNN 모델은 최적의 성능에 미치지 못함
방향성 그래프를 처리하는 NERD, APP와 같은 랜덤워크 기반 모델은 GNN에 비해 성능 떨어짐

2. 노드 / 엣지 피처를 구성하기 위한 제품 속성이 없음
초기 노드 임베딩으로 1-hot 인코딩을 사용하는 GNN 모델은 대규모 그래프에서 메모리 부족 문제를 일으킬 수 있음.
GAT, DGGAN 기반 모델은 대규모 그래프에서 매우 느리고 비효율적.
균등 [-1, 1], 정규 N(0, 1), 자비에 균등, 자비에 정규 등을 사용하여 초기화하면 최적의 성능을 얻지 못할 수 있음.

+ 확장 가능한 솔루션 필요
수십억 개의 상호 작용이 있는 수백만 개의 제품을 처리해야 함
1-hot 인코딩 벡터에 의존하는 기존 작업은 이러한 대규모 데이터셋에서 실패할 가능성

 
### BLADE(Biased Locally Adaptive Direction awarE)
1. 비대칭 처리
소스 및 타겟 임베딩을 이중으로 사용하여 각 노드를 표현
가운데는 휴대폰과 휴대폰 케이스, 전원 어댑터 등 관련 제품 간의 관계를 나타내는 그래프임
왼쪽은 기존 그래프 신경망(GNN)에서 노드 A를 임베딩
오른쪽은 BLADE에서 추천 대상(A-target)과 추천 소스(A-source)로 A를 이중 임베딩
소스 임베딩을 생성할 때는 노드의 out 이웃을 / 타겟 임베딩을 생성할 땐 in 이웃으로
이렇게 이중으로 표현하면 방향성을 구분지을 수 있음

BLADE를 이용해 모든 노드에 대해서 소스 및 타겟 임베딩 생성
쿼리 노드를 임베딩 공간에 매핑 / 잠재적 후보를 타겟 임베딩 공간에 매핑
쿼리 노드에 대한 추천 노드를 찾기 위해 최근접 이웃 탐색(Nearest Neighbor)

2. 노드 피쳐 초기화 Initial Node Embeddings
균일 분포[-1, 1], 정규 분포, Xavier 균등 및 정규 분포 등 사용할 수 있음
이 경우의 노드 피쳐 초기화는 무작위 랜덤 / 노드의 어떤 측면도 특정짓지 않음
최적의 성능을 얻지 못할 가능성이 존재함.
혹은 1-hot 인코딩을 사용할 수도 있음
하지만 이러한 GNN 모델은 대규모 그래프에서 메모리 부족 문제를 일으킬 수 있음.

전체 그래프에 대해 편향된 랜덤 워크(biased random walks)를 수행함
페이지 랭크에서 영감을 받아 RWR(Random walks with Restart) 생성(재시작 확률은 0.15로)
이렇게 생성된 초기 임베딩은 그래프의 연결 구조를 나타내기 때문에 랜덤 초기화보다 더 나음

3. 크고 작은 노드 degree에 대한 추천을 개선하기 위한 샘플링
시드 노드의 degree에 따라 이웃 샘플 크기를 locally 조정
만약 시드 노드의 degree가 낮으면 larger neighborhood로, degree가 높으면 smaller
이웃 샘플링을 수행할 때는 노드의 degree에 따라 샘플링할 엣지의 확률을 차등 처리

물론 GAT(Graph Attention)은 노드마다 다른 가중치를 암시적으로 지정할 수 있음
하지만 Attention 가중치는 노드의 이웃 feature를 기반으로 계산됨
그래프의 구조적 특성을 반영할 수 없다는 한계가 있음
attribution이 없는 그래프에는 GAT를 적용하기 어렵다.
